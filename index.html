<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚡ WormGPT - Secure Login</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Highlight -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --background-color: #0d0d0d;
            --container-bg-color: #1a1a1a;
            --primary-red: #ff0000;
            --text-color: #e0e0e0;
            --border-color: #333;
            --glow-color: rgba(255, 0, 0, 0.5);
            --system-yellow: #f39c12;
            --admin-blue: #007bff;
            --success-green: #28a745;
            --transition-speed: 0.3s;
        }
        html, body { 
            height: 100%; 
            margin: 0; 
            overflow: hidden; 
        }
        body {
            font-family: 'Fira Code', monospace;
            background: radial-gradient(circle, #1a0000 0%, #0a0a0a 100%);
            color: var(--text-color);
            display: flex; 
            justify-content: center; 
            align-items: center;
            transition: background-color 0.5s ease;
        }
        
        /* ====== AUTH PAGES ====== */
        #auth-wrapper {
            width: 90%; 
            max-width: 420px;
            background-color: var(--container-bg-color);
            border: 1px solid var(--primary-red);
            border-radius: 8px;
            padding: 30px 25px;
            box-shadow: 0 0 25px var(--glow-color);
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #auth-wrapper h2 { 
            color: var(--primary-red); 
            margin-top: 0; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .auth-input {
            width: 100%; 
            box-sizing: border-box;
            padding: 12px; 
            margin: 10px 0;
            background: #252525; 
            border: 1px solid var(--border-color);
            border-radius: 5px; 
            color: var(--text-color);
            font-size: 1rem; 
            text-align: center;
            transition: all var(--transition-speed);
        }
        .auth-input:focus { 
            outline: none; 
            border-color: var(--primary-red); 
            box-shadow: 0 0 8px var(--glow-color);
        }
        .auth-button {
            width: 100%; 
            padding: 12px; 
            margin-top: 15px;
            background: var(--primary-red); 
            color: #000;
            border: none; 
            border-radius: 5px;
            font-weight: bold; 
            cursor: pointer;
            transition: all var(--transition-speed);
            position: relative;
            overflow: hidden;
        }
        .auth-button:disabled { 
            background: #555; 
            cursor: not-allowed; 
        }
        .auth-button:not(:disabled):hover {
            background: #ff3333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }
        .auth-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        .auth-button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        .switch-link {
            margin-top: 15px; 
            color: #888; 
            font-size: 0.9rem;
        }
        .switch-link a { 
            color: var(--primary-red); 
            text-decoration: none; 
            transition: color var(--transition-speed);
        }
        .switch-link a:hover {
            text-decoration: underline;
        }
        .error-text { 
            color: var(--system-yellow); 
            height: 20px; 
            margin-top: 10px; 
            transition: all var(--transition-speed);
        }
        .success-text {
            color: var(--success-green);
            height: 20px;
            margin-top: 10px;
            transition: all var(--transition-speed);
        }

        /* ====== CHAT PAGE (hidden by default) ====== */
        #chat-wrapper {
            width: 95%; 
            max-width: 850px; 
            height: 95%; 
            max-height: 900px;
            display: none; 
            flex-direction: column;
            animation: fadeIn 0.5s;
        }
        .chat-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding: 0 10px; 
        }
        #title { 
            font-size: 2.5em; 
            color: var(--primary-red); 
            text-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color); 
            font-weight: 700; 
            margin: 0; 
            animation: title-flicker 3s infinite alternate; 
        }
        @keyframes title-flicker { 
            0%,18%,22%,25%,53%,57%,100% {
                text-shadow: 0 0 4px #fff, 0 0 11px var(--glow-color), 0 0 19px var(--glow-color), 0 0 40px var(--primary-red);
            } 
            20%,24%,55% {
                text-shadow: none;
            } 
        }
        .header-buttons { 
            display: flex; 
            gap: 10px; 
        }
        .header-button { 
            background: none; 
            border: 1px solid var(--border-color); 
            color: var(--text-color); 
            font-size: 18px; 
            cursor: pointer; 
            padding: 8px 12px; 
            border-radius: 5px; 
            transition: all var(--transition-speed); 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        .header-button:hover { 
            border-color: var(--primary-red); 
            color: var(--primary-red); 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.2);
        }
        #chat-container { 
            width: 100%; 
            flex-grow: 1; 
            background-color: var(--container-bg-color); 
            box-shadow: 0 0 25px var(--glow-color); 
            border-radius: 8px; 
            border: 1px solid var(--primary-red); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative; 
        }
        #chat-box { 
            flex-grow: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
        }
        #chat-box::-webkit-scrollbar { 
            width: 8px; 
        }
        #chat-box::-webkit-scrollbar-track { 
            background: var(--container-bg-color); 
        }
        #chat-box::-webkit-scrollbar-thumb { 
            background-color: var(--primary-red); 
            border-radius: 10px; 
            border: 2px solid var(--container-bg-color); 
        }
        .message { 
            padding: 15px 20px; 
            border-radius: 8px; 
            max-width: 90%; 
            line-height: 1.7; 
            word-wrap: break-word; 
            position: relative; 
            animation: message-enter 0.3s ease-out; 
        }
        @keyframes message-enter { 
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        .message-header { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            margin-bottom: 8px; 
            font-size: 0.9em; 
            color: #aaa; 
        }
        .message-header .timestamp { 
            font-size: 0.8em; 
            color: #777; 
        }
        .user-message { 
            background-color: #333; 
            align-self: flex-end; 
            border-right: 3px solid var(--primary-red); 
        }
        .assistant-message { 
            background-color: #222; 
            align-self: flex-start; 
            border-left: 3px solid var(--primary-red); 
            text-align: right; 
        }
        .system-message { 
            border-color: var(--system-yellow); 
            color: var(--system-yellow); 
            font-weight: bold; 
            background-color: #2a251a; 
            align-self: center; 
            text-align: center; 
            max-width: 95%; 
            width: 100%; 
        }
        .message-actions { 
            position: absolute; 
            top: 8px; 
            left: 8px; 
            display: flex; 
            gap: 5px; 
            opacity: 0; 
            visibility: hidden; 
            transition: all var(--transition-speed); 
            z-index: 5; 
        }
        .message:hover .message-actions { 
            opacity: 1; 
            visibility: visible; 
        }
        .action-btn { 
            background: #444; 
            border: 1px solid #666; 
            color: #eee; 
            padding: 4px 8px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 12px; 
            transition: all var(--transition-speed);
        }
        .action-btn:hover { 
            background: #555; 
            transform: scale(1.05);
        }
        .assistant-message pre { 
            position: relative; 
        }
        .copy-code-button { 
            position: absolute; 
            top: 8px; 
            left: 8px; 
            background: #444; 
            border: 1px solid #666; 
            color: #eee; 
            padding: 4px 8px; 
            border-radius: 5px; 
            cursor: pointer; 
            opacity: 0; 
            visibility: hidden; 
            transition: all var(--transition-speed); 
            font-size: 12px; 
            z-index: 5; 
        }
        .assistant-message pre:hover .copy-code-button { 
            opacity: 1; 
            visibility: visible; 
        }
        .assistant-message pre { 
            background-color: #0f0f0f; 
            border: 1px solid var(--border-color); 
            border-radius: 5px; 
            padding: 15px; 
            overflow-x: auto; 
            text-align: left; 
            direction: ltr; 
        }
        .assistant-message code { 
            font-family: 'Fira Code', monospace; 
            font-size: 0.95em; 
        }
        #input-area { 
            display: flex; 
            padding: 15px; 
            border-top: 1px solid var(--border-color); 
            background-color: #101010; 
            gap: 10px; 
            align-items: flex-end; 
        }
        #message-input { 
            flex-grow: 1; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 5px; 
            background-color: #252525; 
            color: var(--text-color); 
            font-family: 'Fira Code', monospace; 
            font-size: 1rem; 
            resize: none; 
            overflow-y: hidden; 
            transition: all var(--transition-speed);
        }
        #message-input:focus { 
            outline: none; 
            border-color: var(--primary-red); 
            box-shadow: 0 0 8px var(--glow-color); 
        }
        #send-button { 
            padding: 12px 25px; 
            border: 1px solid var(--primary-red); 
            background-color: var(--primary-red); 
            color: #000; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 700; 
            transition: all var(--transition-speed); 
        }
        #send-button:disabled { 
            background-color: #555; 
            border-color: #555; 
            color: #888; 
            cursor: not-allowed; 
        }
        #send-button:hover:not(:disabled) { 
            background-color: var(--background-color); 
            color: var(--primary-red); 
            box-shadow: 0 0 10px var(--glow-color); 
            transform: translateY(-2px);
        }
        #bottom-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 5px 15px; 
            background-color: #101010; 
            font-size: 0.8em; 
            color: #888; 
        }
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.8); 
            backdrop-filter: blur(5px); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            animation: fade-in 0.3s; 
        }
        .modal.active { 
            display: flex; 
        }
        @keyframes fade-in { 
            from { 
                opacity: 0; 
            } 
            to { 
                opacity: 1; 
            } 
        }
        .modal-content { 
            background-color: var(--container-bg-color); 
            border: 1px solid var(--primary-red); 
            border-radius: 8px; 
            padding: 30px; 
            width: 90%; 
            max-width: 500px; 
            box-shadow: 0 0 20px var(--glow-color); 
            text-align: center; 
            position: relative; 
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-content h2 { 
            margin-top: 0; 
            color: var(--primary-red); 
        }
        .modal-input { 
            width: 100%; 
            box-sizing: border-box; 
            padding: 12px; 
            margin-top: 15px; 
            background-color: #252525; 
            border: 1px solid var(--border-color); 
            border-radius: 5px; 
            color: var(--text-color); 
            font-size: 1rem; 
            text-align: center; 
            transition: all var(--transition-speed);
        }
        .modal-input:focus {
            outline: none;
            border-color: var(--primary-red);
            box-shadow: 0 0 8px var(--glow-color);
        }
        .modal-button { 
            width: 100%; 
            padding: 12px; 
            margin-top: 20px; 
            background-color: var(--primary-red); 
            border: none; 
            border-radius: 5px; 
            color: #000; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all var(--transition-speed);
        }
        .modal-button:disabled { 
            background-color: #555; 
            cursor: not-allowed; 
        }
        .modal-button:not(:disabled):hover {
            background-color: #ff3333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }
        .close-modal { 
            position: absolute; 
            top: 10px; 
            right: 15px; 
            background: none; 
            border: none; 
            color: #fff; 
            font-size: 28px; 
            cursor: pointer; 
            transition: color var(--transition-speed);
        }
        .close-modal:hover {
            color: var(--primary-red);
        }
        .typing-indicator span { 
            height: 8px; 
            width: 8px; 
            background-color: #555; 
            border-radius: 50%; 
            display: inline-block; 
            animation: bounce 1.4s infinite ease-in-out both; 
        }
        .typing-indicator span:nth-of-type(1) { 
            animation-delay: -0.32s; 
        }
        .typing-indicator span:nth-of-type(2) { 
            animation-delay: -0.16s; 
        }
        @keyframes bounce { 
            0%, 80%, 100% { 
                transform: scale(0); 
            } 
            40% { 
                transform: scale(1.0); 
            } 
        }
        
        /* ====== LOADING ANIMATION ====== */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-red);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ====== TOAST NOTIFICATIONS ====== */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: var(--container-bg-color);
            border: 1px solid var(--primary-red);
            border-radius: 5px;
            box-shadow: 0 0 15px var(--glow-color);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            border-color: var(--success-green);
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
        }
        .toast.error {
            border-color: var(--system-yellow);
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.5);
        }
        
        /* ====== RESPONSIVE DESIGN ====== */
        @media (max-width: 768px) {
            #chat-wrapper {
                width: 98%;
                height: 98%;
            }
            .chat-header {
                flex-direction: column;
                gap: 15px;
            }
            .header-buttons {
                width: 100%;
                justify-content: center;
            }
            .message {
                max-width: 95%;
            }
            #title {
                font-size: 1.8em;
            }
        }
        
        @media (max-width: 480px) {
            #auth-wrapper {
                padding: 20px 15px;
            }
            .header-button span {
                display: none;
            }
            .header-button {
                padding: 10px;
            }
            #input-area {
                flex-direction: column;
                gap: 10px;
            }
            #send-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<!-- ====== صفحة تسجيل الدخول أو إنشاء الحساب ====== -->
<div id="auth-wrapper">
    <!-- نموذج تسجيل الدخول -->
    <div id="login-form">
        <h2><i class="fas fa-lock"></i> تسجيل الدخول</h2>
        <input type="text" id="login-user" class="auth-input" placeholder="اسم المستخدم">
        <input type="password" id="login-pass" class="auth-input" placeholder="كلمة المرور">
        <button id="login-btn" class="auth-button">دخول</button>
        <div class="switch-link">
            ليس لديك حساب؟ <a href="#" id="show-register">إنشاء حساب</a>
        </div>
        <div id="login-err" class="error-text"></div>
    </div>

    <!-- نموذج إنشاء الحساب -->
    <div id="register-form" style="display:none;">
        <h2><i class="fas fa-user-plus"></i> إنشاء حساب</h2>
        <input type="text" id="reg-user" class="auth-input" placeholder="اسم المستخدم (إنجليزي فقط)">
        <input type="password" id="reg-pass" class="auth-input" placeholder="كلمة المرور">
        <input type="password" id="reg-pass2" class="auth-input" placeholder="تأكيد كلمة المرور">
        <input type="text" id="reg-tg" class="auth-input" placeholder="معرّف تيليجرام الرقمي (مطلوب للتحقق)">
        <button id="reg-btn" class="auth-button">الذهاب للتحقق عبر تيليجرام</button> <!-- تم تغيير النص -->
        <div class="switch-link">
            لديك حساب بالفعل؟ <a href="#" id="show-login">تسجيل الدخول</a>
        </div>
        <div id="reg-err" class="error-text"></div>
    </div>
</div>

<!-- ====== واجهة المحادثة (مخفيّة حتى يتم تسجيل الدخول) ====== -->
<div id="chat-wrapper"></div>

<!-- نافذة OTP عبر تيليجرام (تستخدم الآن للتسجيل أو الدخول) -->
<div id="login-modal" class="modal">
    <div class="modal-content">
        <div id="step1-telegram-id">
            <h2 id="modal-title"><i class="fas fa-lock"></i> مصادقة آمنة</h2> <!-- سيتم تحديث العنوان -->
            <p id="modal-instruction">أدخِل معرّف تيليجرام الخاص بك. سنرسل لك رمز تحقّق عبر البوت <a href="https://t.me/WormGPTOTPbot" target="_blank" style="color: var(--primary-red);">@WormGPTOTPbot</a>.</p> <!-- سيتم تحديث النص -->
            <input type="text" id="telegram-id-input" class="modal-input" placeholder="Telegram ID">
            <button id="send-code-button" class="modal-button">إرسال الرمز</button>
        </div>
        <div id="step2-verification-code" style="display: none;">
            <h2><i class="fas fa-key"></i> أدخِل الرمز</h2>
            <p>لقد أرسلنا رمزًا إلى حسابك في تيليجرام. تنتهي صلاحيته بعد 5 دقائق.</p>
            <input type="text" id="code-input" class="modal-input" placeholder="_ _ _ _ _ _" maxlength="6" inputmode="numeric">
            <button id="verify-code-button" class="modal-button">التحقّق وإنهاء التسجيل</button> <!-- تم تغيير النص -->
            <a href="#" id="back-to-step1" style="display: block; margin-top: 15px; color: #888;">العودة</a>
        </div>
        <p id="login-status" style="color: var(--system-yellow); margin-top: 15px; height: 20px;"></p>
    </div>
</div>

<!-- نافذة معلومات -->
<div id="info-modal" class="modal">
    <div class="modal-content">
        <button class="close-modal">&times;</button>
        <h2>معلومات</h2>
        <p>هذه الأداة تستخدم مصادر مجانية للذكاء الاصطناعي لتخفيف الضغط على الخوادم وضمان استمرارية الخدمة للجميع.</p>
    </div>
</div>

<!-- Toast notifications -->
<div id="toast-container"></div>

<script>
    /********************************************************************
     *  تم تحديث منطق التسجيل لإضافة التحقق عبر تيليجرام، وتم تحسين التنظيم.
     ********************************************************************/
    const CONFIG = {
        API_URL: "https://yojagahyhoogwtfpvtok.supabase.co/functions/v1/chat",
        API_KEY: "wgpt_j4s3c63v8l929lgwxienua",
        ADMIN_ID: "7845383853",
        TELEGRAM_BOT_TOKEN: "8284389202:AAGOE_1gEK5RABe6w5OPsVxY9KHj_R2Kh9g",
        WELCOME_MESSAGE: "النظام متصل وجاهز. كيف يمكنني مساعدتك اليوم؟",
        MAX_CONTEXT_MESSAGES: 6
    };

    const DOM = {};
    let conversationHistory = [];
    let currentUser = null;   // {username, tgId, isAdmin}
    let registrationData = null; // لتخزين بيانات التسجيل المؤقتة
    let activeSessionId = null;
    let isProcessing = false;

    /* ============================================================
       =                        AUTH FLOW                         =
       ============================================================ */
    function init() {
        Object.assign(DOM, {
            authWrapper: document.getElementById('auth-wrapper'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            loginUser: document.getElementById('login-user'),
            loginPass: document.getElementById('login-pass'),
            loginBtn: document.getElementById('login-btn'),
            loginErr: document.getElementById('login-err'),
            regUser: document.getElementById('reg-user'),
            regPass: document.getElementById('reg-pass'),
            regPass2: document.getElementById('reg-pass2'),
            regTg: document.getElementById('reg-tg'),
            regBtn: document.getElementById('reg-btn'),
            regErr: document.getElementById('reg-err'),
            showLogin: document.getElementById('show-login'),
            showRegister: document.getElementById('show-register'),
            loginModal: document.getElementById('login-modal'),
            infoModal: document.getElementById('info-modal'),
            toastContainer: document.getElementById('toast-container')
        });

        DOM.showLogin.addEventListener('click', () => toggleAuthForms('login'));
        DOM.showRegister.addEventListener('click', () => toggleAuthForms('register'));
        DOM.loginBtn.addEventListener('click', handleLogin);
        DOM.regBtn.addEventListener('click', handleRegister);

        // OTP modal elements
        DOM.modalTitle = document.getElementById('modal-title');
        DOM.modalInstruction = document.getElementById('modal-instruction');
        DOM.sendCodeButton = document.getElementById('send-code-button');
        DOM.verifyCodeButton = document.getElementById('verify-code-button');
        DOM.telegramIdInput = document.getElementById('telegram-id-input');
        DOM.codeInput = document.getElementById('code-input');
        DOM.loginStatus = document.getElementById('login-status');
        DOM.step1 = document.getElementById('step1-telegram-id');
        DOM.step2 = document.getElementById('step2-verification-code');
        DOM.backToStep1 = document.getElementById('back-to-step1');

        DOM.sendCodeButton.addEventListener('click', handleSendCode);
        DOM.verifyCodeButton.addEventListener('click', handleVerifyCode);
        DOM.backToStep1.addEventListener('click', e => {
            e.preventDefault();
            DOM.step2.style.display = 'none';
            DOM.step1.style.display = 'block';
            DOM.loginStatus.textContent = '';
            if (DOM.step1.dataset.mode === 'register') {
                setupRegistrationModal();
            } else {
                DOM.telegramIdInput.value = currentUser ? currentUser.tgId : '';
            }
        });

        // Info modal
        DOM.infoModal.querySelector('.close-modal').addEventListener('click', () => DOM.infoModal.classList.remove('active'));

        // Check if already logged-in
        checkSession();
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', handleGlobalKeydown);
    }

    function toggleAuthForms(mode) {
        if (mode === 'login') {
            DOM.loginForm.style.display = 'block';
            DOM.registerForm.style.display = 'none';
        } else {
            DOM.loginForm.style.display = 'none';
            DOM.registerForm.style.display = 'block';
        }
    }

    function handleLogin() {
        const user = DOM.loginUser.value.trim();
        const pass = DOM.loginPass.value.trim();
        if (!user || !pass) { 
            showError(DOM.loginErr, 'أدخِل اسم المستخدم وكلمة المرور'); 
            return; 
        }

        const db = getLocalUsers();
        const rec = db[user];
        if (!rec || rec.password !== pass) { 
            showError(DOM.loginErr, 'اسم المستخدم أو كلمة المرور خاطئة'); 
            return; 
        }

        // --- START LOGIN OTP ---
        currentUser = { username: user, tgId: rec.tgId, isAdmin: rec.tgId === CONFIG.ADMIN_ID, isTemp: true };
        setupLoginModal(rec.tgId); // إعداد النافذة لعملية الدخول
    }

    function handleRegister() {
        const user = DOM.regUser.value.trim();
        const pass = DOM.regPass.value.trim();
        const pass2 = DOM.regPass2.value.trim();
        const tg = DOM.regTg.value.trim();

        if (!/^[a-zA-Z0-9_]+$/.test(user)) { 
            showError(DOM.regErr, 'اسم المستخدم يجب أن يكون بالإنجليزية فقط وبدون مسافات'); 
            return; 
        }
        if (pass.length < 4) { 
            showError(DOM.regErr, 'كلمة المرور أقل من 4 أحرف'); 
            return; 
        }
        if (pass !== pass2) { 
            showError(DOM.regErr, 'كلمتا المرور غير متطابقتين'); 
            return; 
        }
        if (!/^\d+$/.test(tg)) { 
            showError(DOM.regErr, 'معرّف تيليجرام يجب أن يكون أرقامًا فقط'); 
            return; 
        }

        const db = getLocalUsers();
        if (db[user]) { 
            showError(DOM.regErr, 'اسم المستخدم موجود مسبقًا'); 
            return; 
        }

        // حفظ البيانات مؤقتاً
        registrationData = { username: user, password: pass, tgId: tg, isAdmin: tg === CONFIG.ADMIN_ID };
        
        // الانتقال إلى خطوة التحقق
        setupRegistrationModal(tg);
    }

    function getLocalUsers() {
        return JSON.parse(localStorage.getItem('wormGptUsers') || '{}');
    }

    function saveSession() {
        localStorage.setItem('wormGptSession', JSON.stringify(currentUser));
    }

    function checkSession() {
        const s = localStorage.getItem('wormGptSession');
        if (s) {
            currentUser = JSON.parse(s);
            showChatInterface();
        } else {
            DOM.authWrapper.style.display = 'block';
        }
    }

    function showError(element, message) {
        element.textContent = message;
        element.style.opacity = '1';
        setTimeout(() => {
            element.style.opacity = '0';
        }, 3000);
    }
    
    // --- OTP Modal Setup Functions ---
    function setupLoginModal(tgId) {
        DOM.modalTitle.innerHTML = '<i class="fas fa-lock"></i> مصادقة آمنة';
        DOM.modalInstruction.innerHTML = 'أدخِل معرّف تيليجرام الخاص بك. سنرسل لك رمز تحقّق عبر البوت <a href="https://t.me/WormGPTOTPbot" target="_blank" style="color: var(--primary-red);">@WormGPTOTPbot</a>.';
        DOM.telegramIdInput.value = tgId;
        DOM.verifyCodeButton.innerHTML = 'التحقّق والدخول';
        DOM.step1.dataset.mode = 'login';
        DOM.loginStatus.textContent = '';
        DOM.step2.style.display = 'none';
        DOM.step1.style.display = 'block';
        DOM.loginModal.classList.add('active');
    }

    function setupRegistrationModal(tgId = '') {
        DOM.modalTitle.innerHTML = '<i class="fas fa-user-plus"></i> تحقق التسجيل';
        DOM.modalInstruction.innerHTML = 'لقد قمت بإدخال بياناتك. لتأكيد ملكية حساب تيليجرام، أدخِل معرّف تيليجرام الخاص بك (الذي سيُربط بالحساب) وسنرسل رمزًا عبر البوت <a href="https://t.me/WormGPTOTPbot" target="_blank" style="color: var(--primary-red);">@WormGPTOTPbot</a>.';
        DOM.telegramIdInput.value = tgId;
        DOM.verifyCodeButton.innerHTML = 'التحقّق وإكمال التسجيل';
        DOM.step1.dataset.mode = 'register';
        DOM.loginStatus.textContent = '';
        DOM.step2.style.display = 'none';
        DOM.step1.style.display = 'block';
        DOM.loginModal.classList.add('active');
    }

    async function handleSendCode() {
        const telegramId = DOM.telegramIdInput.value.trim();
        if (!/^\d+$/.test(telegramId)) { 
            DOM.loginStatus.textContent = "الرجاء إدخال معرّف تيليجرام رقمي صحيح."; 
            return; 
        }

        DOM.loginStatus.textContent = "جاري إرسال الرمز...";
        DOM.sendCodeButton.disabled = true;
        DOM.sendCodeButton.innerHTML = '<span class="loading-spinner"></span> جاري الإرسال...';

        const otp = Math.floor(100000 + Math.random() * 900000).toString();
        const expiry = Date.now() + 5 * 60 * 1000;
        sessionStorage.setItem('otpVerification', JSON.stringify({ id: telegramId, code: otp, expiry }));

        const msg = `[WormGPT] رمز التحقق الخاص بك هو: ${otp}`;
        const url = `https://api.telegram.org/bot${CONFIG.TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${telegramId}&text=${encodeURIComponent(msg)}`;

        try {
            const r = await fetch(url);
            const j = await r.json();
            if (!j.ok) throw new Error(j.description || "فشل إرسال الرسالة. تأكد من أنك بدأت محادثة مع البوت.");
            DOM.loginStatus.textContent = "تم إرسال الرمز بنجاح! تحقق من حسابك في تيليجرام.";
            DOM.step1.style.display = 'none';
            DOM.step2.style.display = 'block';
            DOM.codeInput.focus();
        } catch (e) {
            DOM.loginStatus.textContent = `خطأ: ${e.message}`;
        } finally {
            DOM.sendCodeButton.disabled = false;
            DOM.sendCodeButton.innerHTML = 'إرسال الرمز';
        }
    }

    function handleVerifyCode() {
        const entered = DOM.codeInput.value.trim();
        const data = JSON.parse(sessionStorage.getItem('otpVerification') || '{}');
        const mode = DOM.step1.dataset.mode;

        if (!entered || !data.code) { 
            DOM.loginStatus.textContent = "حدث خطأ ما. حاول مرة أخرى."; 
            return; 
        }
        if (Date.now() > data.expiry) { 
            DOM.loginStatus.textContent = "انتهت صلاحية الرمز. اطلب رمزًا جديدًا."; 
            sessionStorage.removeItem('otpVerification'); 
            return; 
        }
        if (entered !== data.code) { 
            DOM.loginStatus.textContent = "رمز غير صحيح. حاول مرة أخرى."; 
            return; 
        }

        DOM.loginStatus.textContent = "التحقق ناجح! جاري المتابعة...";
        DOM.verifyCodeButton.disabled = true;
        DOM.verifyCodeButton.innerHTML = '<span class="loading-spinner"></span> جاري التحقق...';
        sessionStorage.removeItem('otpVerification');

        if (mode === 'login') {
            // --- COMPLETE LOGIN ---
            currentUser = {
                username: currentUser.username,
                tgId: data.id,
                isAdmin: data.id === CONFIG.ADMIN_ID
            };
            saveSession();
            setTimeout(() => {
                DOM.loginModal.classList.remove('active');
                updateMessageCounterUI();
                DOM.verifyCodeButton.disabled = false;
                DOM.verifyCodeButton.innerHTML = 'التحقّق والدخول';
                showToast('تم تسجيل الدخول بنجاح!', 'success');
                location.reload(); // إعادة تحميل بسيط لضمان تحديث الحالة
            }, 1000);

        } else if (mode === 'register') {
            // --- COMPLETE REGISTRATION ---
            const userData = registrationData;
            userData.tgId = data.id;
            userData.isAdmin = data.id === CONFIG.ADMIN_ID;
            
            const db = getLocalUsers();
            db[userData.username] = { password: userData.password, tgId: userData.tgId };
            localStorage.setItem('wormGptUsers', JSON.stringify(db));

            currentUser = {
                username: userData.username,
                tgId: userData.tgId,
                isAdmin: userData.isAdmin
            };
            saveSession();
            registrationData = null;

            setTimeout(() => {
                DOM.loginModal.classList.remove('active');
                updateMessageCounterUI();
                DOM.verifyCodeButton.disabled = false;
                DOM.verifyCodeButton.innerHTML = 'التحقّق وإكمال التسجيل';
                showChatInterface();
                showToast('تم إنشاء الحساب والتحقق بنجاح!', 'success');
            }, 1000);
        }
    }


    /* ============================================================
       =                     CHAT INTERFACE BUILD                  =
       ============================================================ */
    function showChatInterface() {
        // Build UI exactly as before
        DOM.chatWrapper = document.createElement('div');
        DOM.chatWrapper.id = 'chat-wrapper';
        DOM.chatWrapper.innerHTML = `
            <div class="chat-header">
                <h1 id="title">&lt;WormGPT ⚡/&gt;</h1>
                <div class="header-buttons">
                    <span id="welcome-user" class="header-button" style="border-color: transparent; cursor: default;"></span>
                    <button id="new-chat-button" class="header-button" title="محادثة جديدة"><i class="fas fa-plus"></i> <span>جديد</span></button>
                    <button id="del-chat-button" class="header-button" title="حذف المحادثة"><i class="fas fa-trash"></i> <span>حذف</span></button>
                    <button id="logout-button" class="header-button" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i> <span>خروج</span></button>
                    <button id="clear-button" class="header-button" title="مسح المحادثة"><i class="fas fa-eraser"></i> <span>مسح</span></button>
                </div>
            </div>
            <div id="chat-container">
                <div id="chat-box"></div>
                <div id="input-area">
                    <textarea id="message-input" placeholder="اكتب الأمر هنا..." rows="1"></textarea>
                    <button id="send-button"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div id="bottom-bar">
                    <span id="message-counter"></span>
                    <a href="#" id="info-button" style="color: #888; text-decoration: none;">معلومات</a>
                </div>
            </div>`;
        document.body.appendChild(DOM.chatWrapper);

        // Re-assign dynamic elements
        Object.assign(DOM, {
            chatBox: document.getElementById('chat-box'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            clearButton: document.getElementById('clear-button'),
            logoutButton: document.getElementById('logout-button'),
            welcomeUser: document.getElementById('welcome-user'),
            messageCounter: document.getElementById('message-counter'),
            infoButton: document.getElementById('info-button'),
            newChatButton: document.getElementById('new-chat-button'),
            delChatButton: document.getElementById('del-chat-button')
        });

        // Attach listeners
        DOM.sendButton.addEventListener('click', sendMessage);
        DOM.clearButton.addEventListener('click', clearConversation);
        DOM.logoutButton.addEventListener('click', logout);
        DOM.messageInput.addEventListener('keydown', handleKeydown);
        DOM.messageInput.addEventListener('input', autoResizeTextarea);
        DOM.infoButton.addEventListener('click', () => DOM.infoModal.classList.add('active'));
        DOM.newChatButton.addEventListener('click', newConversation);
        DOM.delChatButton.addEventListener('click', deleteConversation);

        // Hide auth & show chat
        DOM.authWrapper.style.display = 'none';
        DOM.chatWrapper.style.display = 'flex';
        DOM.welcomeUser.innerHTML = `<i class="fas fa-user"></i> مرحبًا, ${currentUser.username}`;

        // Load data
        activeSessionId = `wormGptHistory_${currentUser.username}`;
        loadConversation();
        updateMessageCounterUI();
        
        // Focus on input
        setTimeout(() => {
            DOM.messageInput.focus();
        }, 300);
    }

    /* ============================================================
       =                CONVERSATION & MESSAGE LIMIT               =
       ============================================================ */
    function loadConversation() {
        const saved = localStorage.getItem(activeSessionId);
        if (saved) {
            try {
                conversationHistory = JSON.parse(saved);
                DOM.chatBox.innerHTML = '';
                conversationHistory.forEach(msg => addMessage(msg.role, msg.content, false));
            } catch (e) {
                console.error('Error loading conversation:', e);
                conversationHistory = [];
                addMessage('assistant', CONFIG.WELCOME_MESSAGE);
            }
        } else {
            conversationHistory = [];
            addMessage('assistant', CONFIG.WELCOME_MESSAGE);
        }
    }

    function saveConversation() {
        try {
            localStorage.setItem(activeSessionId, JSON.stringify(conversationHistory));
        } catch (e) {
            console.error('Error saving conversation:', e);
            showToast('حدث خطأ في حفظ المحادثة', 'error');
        }
    }

    function clearConversation() {
        conversationHistory = [];
        localStorage.removeItem(activeSessionId);
        DOM.chatBox.innerHTML = '';
        addMessage('assistant', CONFIG.WELCOME_MESSAGE);
        showToast('تم مسح المحادثة', 'success');
    }

    function newConversation() {
        // Simply clear current view and start fresh session (history kept in LS)
        clearConversation();
    }

    function deleteConversation() {
        if (confirm('حذف المحادثة الحالية نهائيًّا؟')) {
            localStorage.removeItem(activeSessionId);
            conversationHistory = [];
            DOM.chatBox.innerHTML = '';
            addMessage('assistant', CONFIG.WELCOME_MESSAGE);
            showToast('تم حذف المحادثة', 'success');
        }
    }

    function updateMessageCounterUI() {
        if (currentUser.isAdmin) {
            DOM.messageCounter.innerHTML = '<i class="fas fa-crown"></i> وضع المشرف';
            DOM.messageCounter.style.color = 'var(--admin-blue)';
        } else {
            DOM.messageCounter.innerHTML = '<i class="fas fa-infinity"></i> دردشة غير محدودة';
            DOM.messageCounter.style.color = 'var(--success-green)';
        }
    }

    /* ============================================================
       =                     CHAT FUNCTIONS                       =
       ============================================================ */
    async function sendMessage() {
        if (DOM.sendButton.disabled || isProcessing) return;
        const userInput = DOM.messageInput.value.trim();
        if (userInput === '') return;
        
        isProcessing = true;
        addMessage('user', userInput);
        DOM.messageInput.value = '';
        autoResizeTextarea();
        toggleUI(true);
        const loadingMessage = addMessage('assistant', `<div class="typing-indicator"><span></span><span></span><span></span></div>`, false);
        try {
            const contextMessages = conversationHistory.slice(-CONFIG.MAX_CONTEXT_MESSAGES);
            const contextText = contextMessages.map(m => `${m.role === 'user' ? 'User' : 'Assistant'}: ${m.content}`).join('\n');
            const messageWithContext = `بناءً على هذا السياق:\n${contextText}\n\nيرجى الرد باللغة العربية على آخر سؤال من المستخدم.`;
            const payload = { api_key: CONFIG.API_KEY, message: messageWithContext };
            const response = await fetch(CONFIG.API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { 
                const err = await response.json().catch(() => ({ error: `Request Failed. Status: ${response.status}` })); 
                throw new Error(err.error); 
            }
            const result = await response.json();
            const botReply = result.response || 'لم يتم العثور على رد.';
            loadingMessage.remove();
            addMessage('assistant', botReply);
        } catch (error) {
            loadingMessage.remove();
            addMessage('system', `// ERROR\nحدث خطأ في الاتصال: ${error.message}`);
            showToast('حدث خطأ في الاتصال بالخادم', 'error');
        } finally {
            toggleUI(false);
            isProcessing = false;
        }
    }

    function addMessage(role, content, save = true) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', `${role}-message`);
        const header = document.createElement('div');
        header.className = 'message-header';
        const icon = role === 'user' ? 'fa-user' : 'fa-robot';
        const time = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        header.innerHTML = `<i class="fas ${icon}"></i> <span>${role === 'user' ? 'أنت' : 'WormGPT'}</span> <span class="timestamp">${time}</span>`;
        const contentDiv = document.createElement('div');
        contentDiv.innerHTML = marked.parse(content);
        messageDiv.appendChild(header);
        messageDiv.appendChild(contentDiv);
        if (role === 'assistant' && !content.includes('typing-indicator')) {
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            const copyBtn = document.createElement('button');
            copyBtn.className = 'action-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> نسخ';
            copyBtn.onclick = () => { 
                navigator.clipboard.writeText(content).then(() => { 
                    copyBtn.innerHTML = '<i class="fas fa-check"></i> تم!'; 
                    setTimeout(() => copyBtn.innerHTML = '<i class="fas fa-copy"></i> نسخ', 2000); 
                }); 
            };
            actions.appendChild(copyBtn);
            messageDiv.appendChild(actions);
            addCodeCopyButtons(messageDiv);
            messageDiv.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
        }
        DOM.chatBox.appendChild(messageDiv);
        scrollToBottom(true);
        if (save) { 
            conversationHistory.push({ role, content }); 
            saveConversation(); 
        }
        return messageDiv;
    }

    function addCodeCopyButtons(messageElement) {
        messageElement.querySelectorAll('pre').forEach(block => {
            const button = document.createElement('button');
            button.className = 'copy-code-button';
            button.innerHTML = '<i class="fas fa-code"></i> نسخ';
            button.onclick = () => {
                const code = block.querySelector('code').innerText;
                navigator.clipboard.writeText(code).then(() => {
                    button.innerHTML = '<i class="fas fa-check"></i> تم!';
                    setTimeout(() => button.innerHTML = '<i class="fas fa-code"></i> نسخ', 2000);
                });
            };
            block.appendChild(button);
        });
    }

    function toggleUI(isLoading) {
        DOM.sendButton.disabled = isLoading;
        DOM.messageInput.disabled = isLoading;
        if (isLoading) {
            DOM.sendButton.innerHTML = '<span class="loading-spinner"></span>';
        } else {
            DOM.sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            DOM.messageInput.focus();
        }
    }

    function logout() {
        localStorage.removeItem('wormGptSession');
        currentUser = null;
        location.reload();
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'success' ? 'fa-check-circle' : 
                     type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
        toast.innerHTML = `
            <i class="fas ${icon}"></i>
            <span>${message}</span>
        `;
        DOM.toastContainer.appendChild(toast);
        
        // Show toast
        setTimeout(() => {
            toast.classList.add('show');
        }, 100);
        
        // Hide toast after 3 seconds
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }

    function handleGlobalKeydown(e) {
        // Ctrl+Enter to send message
        if (e.ctrlKey && e.key === 'Enter' && DOM.messageInput) {
            e.preventDefault();
            sendMessage();
        }
        
        // Escape to clear input
        if (e.key === 'Escape' && DOM.messageInput) {
            DOM.messageInput.value = '';
            autoResizeTextarea();
        }
    }

    const handleKeydown = e => { 
        if (e.key === 'Enter' && !e.shiftKey) { 
            e.preventDefault(); 
            sendMessage(); 
        } 
    };
    
    const autoResizeTextarea = () => { 
        DOM.messageInput.style.height = 'auto'; 
        DOM.messageInput.style.height = Math.min(DOM.messageInput.scrollHeight, 200) + 'px'; 
    };
    
    const scrollToBottom = (force = false) => { 
        if (force || (DOM.chatBox.scrollHeight - DOM.chatBox.clientHeight <= DOM.chatBox.scrollTop + 50)) 
            DOM.chatBox.scrollTop = DOM.chatBox.scrollHeight; 
    };

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
            </html>
